import logging
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
)

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)

# تعریف مراحل مکالمه
NAME, AGE, QUESTION = range(3)

# سوالات تست آمادگی رابطه
questions = [
    {
    "text": "سوال 1: وقتی با نظر مخالف شریک زندگی خود مواجه می شوید، معمولا چه واکنشی نشان می دهید؟",
    "options": {
        "الف": "سریع بحث را تمام می کنم\nبرای توافق، حتی غیر متقاعد.",
        "ب": "گوش می دهم، درک می کنم\nنظرم را محترمانه می گویم.",
        "ج": "ناراحت می شوم، سکوت می کنم\nبرای جلوگیری از بحث بیشتر.",
        "د": "فورا متقاعد می کنم\nکه اشتباه می کند، نظر من درست.",
        "ه": "بسته به موضوع، گوش می دهم سریع بحث را تمام می کنم."
        },
    "scores": {
        "الف": 1,
        "ب": 5,
        "ج": 2,
        "د": 1,
        "ه": 3
        },
    "messages": {
        "الف": "این گزینه نشان دهنده تمایل به اجتناب از تعارض است. پیام این گزینه می تواند این باشد که شما ارزش زیادی برای صلح و آرامش قائل هستید، اما ممکن است از پرداختن به مسائل مهم و حل اختلافات به طور موثر اجتناب کنید. در یک رابطه سالم، حل تعارضات به روش سازنده ضروری است.",
        "ب": "این گزینه نشان دهنده مهارت بالای ارتباطی و همدلی است. پیام این گزینه این است که شما توانایی شنیدن فعال، درک دیدگاه های مختلف و بیان نظرات خود را به شیوه ای محترمانه دارید. این یک نشانه بسیار مثبت برای آمادگی رابطه است.",
        "ج": "این گزینه نشان دهنده ناراحتی در مواجهه با تعارض و احتمالا سبک ارتباطی منفعل است. پیام این گزینه می تواند این باشد که شما نیاز دارید بر روی مدیریت احساسات خود در مواجهه با تعارض و بیان نیازهایتان به شیوه ای قاطعانه تر کار کنید.",
        "د": "این گزینه نشان دهنده سبک ارتباطی تهاجمی و عدم تمایل به درک دیدگاه های دیگر است. پیام این گزینه این است که شما ممکن است در روابط خود کنترل گر باشید و نیاز دارید بر روی پذیرش دیدگاه های مختلف و احترام به نظرات دیگران کار کنید.",
        "ه": "این گزینه نشان می دهد که ثبات رویه در نحوه برخورد با اختلافات ندارید. پیام این گزینه می تواند این باشد که نیاز دارید آگاهانه تر به نحوه واکنش خود در موقعیت های مختلف توجه کنید و سعی کنید رویکرد سازنده تر و همدلانه تری را در پیش بگیرید."
        }
    },
    {
    "text": "سوال 2: اگر شریک زندگی شما به دلیل مشکلی در زندگی شخصی اش، اخلاق خوبی نداشته باشد، چه می کنید؟",
    "options": {
        "الف": "فورا ناراحت می شوم\nدعوا می کنم چرا بد اخلاق است.",
        "ب": "فضا می دهم\nامیدوارم خودش بهتر شود.",
        "ج": "نگران می شوم\nمی فهمم مشکلش چیست و کمک می کنم.",
        "د": "مشکل خودش است\nبه من ربطی ندارد.",
        "ه": "تحمل می کنم، ناراحت می شوم\nبعدا با دوستم می گویم."
        },
    "scores": {
        "الف": 1,
        "ب": 2,
        "ج": 5,
        "د": 1,
        "ه": 1
        },
    "messages": {
        "الف": "این گزینه نشان دهنده واکنش هیجانی و عدم همدلی است.",
        "ب": "این گزینه نشان دهنده تمایل به دادن فضا، اما می تواند نشانه ای از اجتناب از حمایت فعال باشد.",
        "ج": "این گزینه نشان دهنده همدلی، نگرانی و تمایل به حمایت است.",
        "د": "این گزینه نشان دهنده عدم تعهد و عدم احساس مسئولیت در قبال شریک زندگی است.",
        "ه": "این گزینه نشان دهنده سبک ارتباطی منفعل-تهاجمی و عدم بیان مستقیم احساسات است."
        }
    },
    {
    "text": "سوال 3: چه چیزی در یک رابطه بیشتر از همه برای شما اهمیت دارد؟",
    "options": {
        "الف": "هیجان و جذابیت اولیه\nلحظات پرشور.",
        "ب": "امنیت، اعتماد\nآرامش و اطمینان.",
        "ج": "علایق و سرگرمی مشترک\nاوقات خوش با هم.",
        "د": "پیشرفت فردی\nرسیدن به اهداف با حمایت.",
        "ه": "بسته به شرایط/فرد مقابل\nاولویت ها فرق می کند."
        },
    "scores": {
        "الف": 1,
        "ب": 5,
        "ج": 3,
        "د": 4,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده تمرکز بر جنبه های سطحی و زودگذر رابطه است.",
        "ب": "این گزینه نشان دهنده ارزش قائل شدن به بنیان های اصلی یک رابطه سالم است.",
        "ج": "این گزینه نشان دهنده اهمیت قائل شدن به تفریح و خوشگذرانی در رابطه است که مهم است، اما کافی نیست.",
        "د": "این گزینه نشان دهنده ارزش قائل شدن به رشد فردی و حمایت متقابل در رابطه است.",
        "ه": "این گزینه نشان دهنده عدم ثبات در ارزش ها و انتظارات از رابطه است."
        }
    },
    {
    "text": "سوال 4: وقتی شریک زندگی شما انتقادی از شما می کند، چه واکنشی نشان می دهید؟",
    "options": {
        "الف": "فورا تدافعی می گیرم\nدفاع می کنم.",
        "ب": "ناراحت می شوم، نشان نمی دهم\nفقط گوش می کنم.",
        "ج": "آرام می باشم\nمی پرسم منظورش چیست و چطور بهتر شوم.",
        "د": "انتقاد را نادیده می گیرم\nاذیتم می کند.",
        "ه": "بسته به انتقاد/حالم\nگاهی تدافعی، گاهی گوش می کنم."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده واکنش تدافعی و عدم پذیرش مسئولیت است.",
        "ب": "این گزینه نشان دهنده ناراحتی از انتقاد و سبک ارتباطی منفعل است.",
        "ج": "این گزینه نشان دهنده بلوغ عاطفی، تمایل به رشد و پذیرش مسئولیت است.",
        "د": "این گزینه نشان دهنده اجتناب از مسئولیت، بدبینی و عدم اعتماد است.",
        "ه": "این گزینه نشان می دهد که ثبات رویه در نحوه برخورد با انتقاد ندارید."
        }
    },
    {
    "text": "سوال 5: اگر متوجه شوید که شریک زندگی شما به شما دروغ گفته است، چه می کنید؟",
    "options": {
        "الف": "قطع رابطه، دروغ نابخشودنی ",
        "ب": "ناراحت/بی اعتماد می شوم\nوانمود می کنم چیزی نشده.",
        "ج": "بررسی بخشش، آرام صحبت",
        "د": "اعتمادم را از دست می دهم\nدیگر هیچ وقت باور نمی کنم.",
        "ه": "بسته به دروغ/شرایط\nواکنش متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده عدم بخشش و قاطعیت بیش از حد است.",
        "ب": "این گزینه نشان دهنده سرکوب احساسات و اجتناب از مواجهه با مشکل است.",
        "ج": "این گزینه نشان دهنده تمایل به گفتگو، درک و احتمال بخشش است.",
        "د": "این گزینه نشان دهنده عدم اعتماد و احتمالا کینه توزی است.",
        "ه": "این گزینه نشان دهنده نیاز به شفافیت بیشتر در ارزش ها و مرزها است."
        }
    },
    {
    "text": "سوال 6: به نظر شما، مهمترین مهارت ارتباطی در یک رابطه چیست؟",
    "options": {
        "الف": "متقاعد کردن شریک زندگی\nبه انجام خواسته هایم.",
        "ب": "تعریف و تمجید\nابراز علاقه.",
        "ج": "گوش دادن فعال\nهمدلانه.",
        "د": "بحث کردن\nبرنده شدن در بحث.",
        "ه": "حدس زدن نیازها\nبدون گفتن."
        },
    "scores": {
        "الف": 1,
        "ب": 3,
        "ج": 5,
        "د": 1,
        "ه": 1
        },
    "messages": {
        "الف": "این گزینه نشان دهنده تمرکز بر کنترل و منفعت شخصی در ارتباطات است.",
        "ب": "این گزینه نشان دهنده اهمیت قائل شدن به ابراز محبت و قدردانی در ارتباطات است، که مهم است، اما کافی نیست.",
        "ج": "این گزینه نشان دهنده درک درست از اهمیت ارتباطات موثر است.",
        "د": "این گزینه نشان دهنده دیدگاه رقابتی به ارتباطات است.",
        "ه": "این گزینه نشان دهنده انتظار غیرواقعی از ارتباطات و عدم وضوح در مرزهای شخصی است."
        }
    },
    {
    "text": "سوال 7: وقتی احساس می کنید نیازهای عاطفی شما در رابطه برآورده نمی شود، چه می کنید؟",
    "options": {
        "الف": "ناراحت/ناامید می شوم\nبه فکر جدایی می افتم.",
        "ب": "نادیده می گیرم\nمشغول چیزهای دیگر می شوم.",
        "ج": "آرام صحبت می کنم\nنیازهایم را واضح بیان می کنم.",
        "د": "سکوت می کنم\nامیدوارم خودش بفهمد و تغییر کند.",
        "ه": "بسته به نارضایتی/شرایط\nواکنش متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده واکنش هیجانی و عدم تحمل نارضایتی است.",
        "ب": "این گزینه نشان دهنده اجتناب از احساسات و مشکلات است.",
        "ج": "این گزینه نشان دهنده ارتباط قاطعانه و مسئولیت پذیری در قبال نیازهای خود است.",
        "د": "این گزینه نشان دهنده ارتباط منفعل و انتظار غیرواقعی است.",
        "ه": "این گزینه نشان دهنده نیاز به ثبات رویه بیشتر در بیان نیازها و حل مشکلات است."
        }
    },
    {
        "text": "سوال 8: به نظر شما، چه میزان از حریم شخصی در یک رابطه سالم باید وجود داشته باشد؟",
        "options":{
            "الف": "هیچ حریم شخصی نباشد\nهمه چیز مشترک باشد.",
            "ب": "حریم شخصی خیلی مهم است\nزندگی شخصی مستقل.",
            "ج": "حریم شخصی متعادل\nنزدیکی و فضای فردی.",
            "د": "حریم شخصی بستگی به نوع رابطه دارد\nروابط جدی حریم کمتر.",
            "ه": "بسته به شخصیت/نیازهای فردی\nحریم شخصی متفاوت."
        },
        "scores": {
            "الف": 1,
            "ب": 1,
            "ج": 5,
            "د": 4,
            "ه": 5
        },
        "messages": {
            "الف": "این گزینه نشان دهنده وابستگی ناسالم و عدم درک مرزهای شخصی است.",
            "ب": "این گزینه نشان دهنده تاکید بیش از حد بر استقلال و دوری از صمیمیت است.",
            "ج": "این گزینه نشان دهنده درک درست از اهمیت تعادل در حریم شخصی است.",
            "د": "این گزینه نشان دهنده درک نسبی از حریم شخصی اما عدم توجه به نیازهای فردی است.",
            "ه": "این گزینه نشان دهنده درک درست از اهمیت فردیت و انعطاف پذیری در حریم شخصی است."
        }
    },
    {
    "text": "سوال 9: اگر شریک زندگی شما مرتکب اشتباه بزرگی شود که به شما آسیب بزند، اما واقعا پشیمان باشد، چه می کنید؟",
    "options": {
        "الف": "بخشیدن غیرممکن است\nرابطه را تمام می کنم.",
        "ب": "می گویم بخشیدم\nهیچ وقت اعتماد ندارم.",
        "ج": "صحبت می کنم\nو سنجش پشیمانی، بخشش را بررسی می کنم.",
        "د": "فرصت جبران می دهم\nمطمئن نیستم ببخشم.",
        "ه": "بسته به اشتباه/آسیب\nتصمیم متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 3,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده عدم بخشش و قاطعیت بیش از حد است.",
        "ب": "این گزینه نشان دهنده بخشش ظاهری و کینه توزی درونی است.",
        "ج": "این گزینه نشان دهنده تمایل به گفتگو، درک، بخشش و ترمیم رابطه است.",
        "د": "این گزینه نشان دهنده تمایل به بخشش، اما تردید و احتیاط است.",
        "ه": "این گزینه نشان دهنده نیاز به شفافیت بیشتر در ارزش ها و مرزها است."
        }
    },
    {
    "text": "سوال 10: به نظر شما، نقش خانواده ها در یک رابطه عاشقانه تا چه حد باید باشد؟",
    "options": {
        "الف": "خانواده نقش اصلی\nتصمیمات با تایید آنها.",
        "ب": "خانواده ها هیچ دخالتی نکنند\nرابطه فقط بین دو نفر.",
        "ج": "خانواده نقش حمایتی/مشورتی\nتصمیم با زوج.",
        "د": "نقش خانواده بستگی به فرهنگ دارد\nسنت های خانوادگی.",
        "ه": "بسته به صمیمیت/نیاز فردی\nنقش خانواده متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 2,
        "ه": 4
        },
    "messages": {
        "الف": "این گزینه نشان دهنده وابستگی ناسالم به خانواده و عدم استقلال در رابطه است.",
        "ب": "این گزینه نشان دهنده دوری بیش از حد از خانواده و عدم استفاده از حمایت آنها است.",
        "ج": "این گزینه نشان دهنده درک درست از نقش سالم خانواده ها در رابطه است.",
        "د": "این گزینه نشان دهنده توجه به زمینه فرهنگی اما عدم توجه به نیازهای فردی است.",
        "ه": "این گزینه نشان دهنده درک درست از اهمیت فردیت و انعطاف پذیری در حریم شخصی است."
        }
    },
    {
    "text": "سوال 11: وقتی با استرس و مشکلات زندگی روبرو می شوید، چگونه با شریک زندگی خود ارتباط برقرار می کنید؟",
    "options": {
        "الف": "خودم حل می کنم\nنمی خواهم درگیرش کنم.",
        "ب": "بدخلق/کم حوصله می شوم\nانتظار توجه دارم.",
        "ج": "می گویم استرس دارم\nنیاز به حمایت دارم.",
        "د": "سکوت می کنم\nفاصله می گیرم.",
        "ه": "بسته به مشکل/حالم\nواکنش متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده تمایل به استقلال بیش از حد و اجتناب از صمیمیت در زمان های سخت است.",
        "ب": "این گزینه نشان دهنده ارتباط غیرمستقیم، منفعل-تهاجمی و انتظار حدس زدن خواسته ها است.",
        "ج": "این گزینه نشان دهنده ارتباط مستقیم، قاطعانه و مسئولیت پذیری در قبال نیازهای خود است.",
        "د": "این گزینه نشان دهنده اجتناب از ارتباط در زمان های سخت است.",
        "ه": "این گزینه نشان دهنده نیاز به ثبات رویه بیشتر در نحوه ارتباط در زمان های سخت است."
        }
    },
    {
    "text": "سوال 12: اگر شریک زندگی شما رفتاری انجام دهد که برای شما قابل قبول نباشد و با ارزش های شما مغایرت داشته باشد، چه می کنید؟",
    "options": {
        "الف": "تحمل می کنم\nامیدوارم خودش بفهمد/تغییر کند.",
        "ب": "فورا ناراحت می شوم\nرابطه را تمام می کنم.",
        "ج": "صحبت می کنم\nتوضیح می دهم چرا قابل قبول نیست.",
        "د": "سکوت می کنم\nفاصله می گیرم.",
        "ه": "بسته به رفتار/مغایرت با ارزش ها\nواکنش متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده منفعل بودن و عدم بیان مرزها است.",
        "ب": "این گزینه نشان دهنده قاطعیت بیش از حد و عدم تحمل اختلاف نظر است.",
        "ج": "این گزینه نشان دهنده ارتباط قاطعانه، مسئولیت پذیری در قبال ارزش ها و تمایل به گفتگو است.",
        "د": "این گزینه نشان دهنده اجتناب از ارتباط و بیان مرزها است.",
        "ه": "این گزینه نشان دهنده نیاز به شفافیت بیشتر در ارزش ها و مرزها است."
        }
    },
    {
    "text": "سوال 13: اگر شریک زندگی شما در مورد موضوع مهمی با شما مشورت کند، اما در نهایت تصمیمی بگیرد که با نظر شما متفاوت باشد، چه می کنید؟",
    "options": {
        "الف": "احساس نادیده گرفته شدن\nکمی ناراحت می شوم.",
        "ب": "فورا عصبانی می شوم\nچرا نظرم را نادیده گرفت؟",
        "ج": "تصمیمش را می پذیرم\nاحترام می گذارم.",
        "د": "متقاعد می کنم\nتصمیمش اشتباه است، نظر مرا قبول کند.",
        "ه": "بسته به موضوع/مخالفتم\nواکنش متفاوت."
        },
    "scores": {
        "الف": 2,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده احساس ناراحتی طبیعی از نادیده گرفته شدن، اما پذیرش ضمنی حق انتخاب شریک زندگی است.",
        "ب": "این گزینه نشان دهنده واکنش هیجانی و عدم احترام به استقلال شریک زندگی است.",
        "ج": "این گزینه نشان دهنده درک درست از مشورت و احترام به استقلال فردی است.",
        "د": "این گزینه نشان دهنده تلاش برای کنترل و عدم پذیرش حق انتخاب دیگران است.",
        "ه": "این گزینه نشان دهنده نیاز به ثبات رویه بیشتر در احترام به استقلال شریک زندگی است."
        }
    },
    {
    "text": "سوال 14: به نظر شما، چه میزان از زمان و انرژی خود را باید به یک رابطه اختصاص داد؟",
    "options": {
        "الف": "تمام وقت/انرژی را به رابطه\nاولویت اصلی رابطه.",
        "ب": "رابطه بخشی از زندگی\nتوجه به جنبه های دیگر هم مهم است.",
        "ج": "بستگی به مراحل رابطه دارد\nاول رابطه زمان بیشتر.",
        "د": "بستگی به نیاز طرفین\nباید توافقی باشد.",
        "ه": "بسته به شرایط زندگی/تعهدات\nزمان/انرژی متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 5,
        "ج": 3,
        "د": 5,
        "ه": 4
        },
    "messages": {
        "الف": "این گزینه نشان دهنده وابستگی ناسالم و عدم تعادل در زندگی است.",
        "ب": "این گزینه نشان دهنده درک درست از اهمیت تعادل در زندگی و رابطه است.",
        "ج": "این گزینه نشان دهنده درک نسبی از تغییر نیازها در مراحل مختلف رابطه است.",
        "د": "این گزینه نشان دهنده درک درست از اهمیت توافق و احترام به نیازهای طرفین است.",
        "ه": "این گزینه نشان دهنده درک درست از اهمیت انعطاف پذیری و احترام به شرایط فردی در اختصاص زمان و انرژی به رابطه است."
        }
    },
    {
    "text": "سوال 15: اگر شریک زندگی شما در مورد موضوعی که برای شما بسیار حساس و شخصی است، شوخی نامناسبی کند، چه می کنید؟",
    "options": {
        "الف": "تحمل می کنم\nنباید حساسیت بیش از حد نشان دهم.",
        "ب": "فورا عصبانی می شوم\nشوخی ات خنده دار نبود، ناراحت شدم.",
        "ج": "آرام صحبت می کنم\nتوضیح می دهم چرا حساس است.",
        "د": "سکوت می کنم\nفاصله می گیرم.",
        "ه": "بسته به شوخی/حالم\nواکنش متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 2,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده منفعل بودن و عدم بیان مرزها است.",
        "ب": "این گزینه نشان دهنده واکنش هیجانی اما بیان مستقیم ناراحتی است.",
        "ج": "این گزینه نشان دهنده ارتباط قاطعانه، مسئولیت پذیری در قبال احساسات و تمایل به آموزش و درک متقابل است.",
        "د": "این گزینه نشان دهنده اجتناب از ارتباط و بیان مرزها است.",
        "ه": "این گزینه نشان دهنده نیاز به ثبات رویه بیشتر در بیان مرزها است."
        }
    },
    {
    "text": "سوال 16: اگر متوجه شوید که شریک زندگی شما به طور مداوم در مورد شما با دیگران غیبت می کند، چه می کنید؟",
    "options": {
        "الف": "نادیده می گیرم\nمهم نیست چه می گوید.",
        "ب": "فورا عصبانی می شوم\nرابطه را تمام می کنم، غیبت غیرقابل قبول.",
        "ج": "آرام صحبت می کنم\nمی پرسم چرا غیبت می کند، ناراحتم.",
        "د": "سکوت می کنم\nفاصله می گیرم.",
        "ه": "بسته به غیبت/شرایط\nواکنش متفاوت."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده منفعل بودن و بی توجهی به رفتارهای آسیب زننده است.",
        "ب": "این گزینه نشان دهنده واکنش هیجانی و قاطعیت بیش از حد است.",
        "ج": "این گزینه نشان دهنده ارتباط قاطعانه، مسئولیت پذیری در قبال ارزش ها و تمایل به گفتگو است."
        }
    },
    {
    "text": "سوال 17:  به نظر شما، مهمترین جنبه تعهد در یک رابطه چیست؟",
    "options": {
        "الف": "وفاداری ظاهری و پرهیز از خیانت به هر قیمتی",
        "ب": "حمایت مالی و تامین نیازهای زندگی\nشریک زندگی.",
        "ج": "صداقت، اعتماد، وفاداری عاطفی ",
        "د": "رعایت تعهدات \nحتی اگر رابطه رضایت بخش نباشد.",
        "ه": "بسته به تعریف شخصی از تعهد و شرایط "
        },
    "scores": {
        "الف": 1,
        "ب": 2,
        "ج": 5,
        "د": 1,
        "ه": 4
        },
    "messages": {
        "الف": "این گزینه نشان دهنده درک سطحی و محدود از تعهد است. پیام این گزینه می تواند این باشد که شما ممکن است تعهد را صرفا به عنوان وفاداری فیزیکی و اجتناب از خیانت ببینید، در حالی که تعهد ابعاد عمیق تری مانند وفاداری عاطفی، صداقت و تلاش برای حفظ رابطه را نیز شامل می شود.",
        "ب": "این گزینه نشان دهنده نگاه ابزاری به تعهد و محدود کردن آن به جنبه های مادی است. پیام این گزینه می تواند این باشد که شما ممکن است تعهد را بیشتر به عنوان یک وظیفه مالی و تامین نیازهای مادی ببینید تا به عنوان یک پیوند عاطفی عمیق و متقابل.",
        "ج": "این گزینه نشان دهنده درک جامع و عمیق از تعهد در رابطه است. پیام این گزینه این است که شما می دانید تعهد شامل ابعاد مختلفی از جمله صداقت، اعتماد، وفاداری عاطفی و تلاش برای حفظ رابطه در بلندمدت است. این یک دیدگاه بالغانه و مثبت برای آمادگی رابطه است.",
        "د": "این گزینه نشان دهنده تاکید بیش از حد بر جنبه های بیرونی و اجتماعی تعهد و نادیده گرفتن رضایت شخصی است. پیام این گزینه می تواند این باشد که شما ممکن است تعهد را بیشتر به عنوان یک وظیفه اجتماعی و خانوادگی ببینید تا به عنوان یک انتخاب شخصی و رابطه رضایت بخش.",
        "ه": "این گزینه نشان دهنده درک نسبی از فردی بودن مفهوم تعهد، اما عدم تاکید کافی بر جنبه های اساسی آن است. پیام این گزینه می تواند این باشد که شما نیاز دارید در کنار توجه به تعریف شخصی از تعهد، به جنبه های اساسی و مشترک تعهد در روابط سالم نیز توجه کنید."
        }
    },
    {
    "text": "سوال 18:  اگر شریک زندگی شما دائماً شما را با افراد دیگر مقایسه کند (مثلاً بگوید «چرا تو مثل فلانی نیستی؟»)، چه واکنشی نشان می دهید؟",
    "options": {
        "الف": "تلاش بیشتر، جلب رضایت تا شبیه آن فرد شوم .",
        "ب":  "ناراحت و عصبانی می شوم\n می گویم که مقایسه کردن درست نیست.",
        "ج": "با آرامش از او می پرسم\nچرا مرا مقایسه می کندوانتظاراتش چیست؟.",
        "د": "ممکن است سکوت کنم\n چون احساس می کنم کافی نیستم.",
        "ه": "بسته به فردی که با او مقایسه می کند و حالم،\nواکنش متفاوته."
        },
    "scores": {
        "الف": 1,
        "ب": 2,
        "ج": 5,
        "د": 1,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده عزت نفس پایین و تلاش برای جلب رضایت دیگران به قیمت نادیده گرفتن خود است. پیام این گزینه می تواند این باشد که شما نیاز دارید بر روی تقویت عزت نفس خود و ارزش قائل شدن برای فردیت خود کار کنید. مقایسه شدن تحقیرآمیز است و نباید تحمل شود.",
        "ب": "این گزینه نشان دهنده واکنش هیجانی اما بیان مستقیم ناراحتی و مرزبندی است. پیام این گزینه می تواند این باشد که شما در بیان ناراحتی خود قاطع هستید، اما نیاز دارید بر روی مدیریت بهتر خشم و بیان احساسات به شیوه ای آرام تر و سازنده تر کار کنید.",
        "ج": "این گزینه نشان دهنده ارتباط قاطعانه، مسئولیت پذیری در قبال احساسات و تمایل به گفتگو برای حل مشکل است. پیام این گزینه این است که شما توانایی بیان مرزهای خود به شیوه ای سالم و سازنده و تلاش برای درک دلیل رفتار شریک زندگی خود را دارید. این یک رویکرد بالغانه و مثبت برای آمادگی رابطه است.",
        "د": "این گزینه نشان دهنده عزت نفس پایین، اجتناب از مواجهه و سبک ارتباطی منفعل است. پیام این گزینه می تواند این باشد که شما نیاز دارید بر روی تقویت عزت نفس خود، بیان مستقیم احساسات و مرزبندی سالم کار کنید.",
        "ه": "این گزینه نشان دهنده نیاز به ثبات رویه بیشتر در برخورد با رفتارهای نامناسب و مرزبندی سالم است. پیام این گزینه می تواند این باشد که شما نیاز دارید آگاهانه تر به نحوه واکنش خود در موقعیت های مختلف توجه کنید و سعی کنید رویکرد قاطعانه تر و مسئولیت پذیرانه تری را در پیش بگیرید."
        }
    },
    {
    "text": "سوال 19:  اگر شریک زندگی شما به طور مداوم وعده هایی بدهد که به آنها عمل نکند، چه می کنید؟",
    "options": {
        "الف": "پذیرش بهانه های او",
        "ب": "ناامید، حس بی اهمیتی می کنم",
        "ج": "توضیح بدقولی، کم شدن اعتماد",
        "د": "اعتماد به وعده اش ندارم",
        "ه": "نوع وعده/تکرار، واکنش متفاوت"
        },
    "scores": {
        "الف": 1,
        "ب": 2,
        "ج": 5,
        "د": 3,
        "ه": 2
        },
    "messages": {
        "الف": "این گزینه نشان دهنده تمایل به نادیده گرفتن رفتارهای نامناسب و اجتناب از مواجهه است. پیام این گزینه می تواند این باشد که شما نیاز دارید بر روی ارزش قائل شدن برای خود، بیان مرزهای سالم و قاطعیت در روابط کار کنید. پذیرش مداوم بدقولی به رابطه آسیب می زند و اعتماد را خدشه دار می کند.",
        "ب": "این گزینه نشان دهنده واکنش هیجانی و احساس قربانی شدن است. پیام این گزینه می تواند این باشد که شما نیاز دارید بر روی مدیریت بهتر احساسات خود و بیان نیازها و انتظارات به شیوه ای سازنده تر کار کنید.",
        "ج": "این گزینه نشان دهنده ارتباط قاطعانه، مسئولیت پذیری در قبال احساسات و تلاش برای حل مشکل است. پیام این گزینه این است که شما توانایی بیان مرزهای خود به شیوه ای سالم و سازنده و تلاش برای حل مشکلات را دارید. این یک رویکرد بالغانه و مثبت برای آمادگی رابطه است.",
        "د": "این گزینه نشان دهنده کاهش تدریجی اعتماد و سازگاری منفعلانه با شرایط نامطلوب است. پیام این گزینه می تواند این باشد که شما نیاز دارید بر روی بیان مستقیم نارضایتی خود و تلاش فعالانه برای حل مشکلات کار کنید، نه فقط سازگاری منفعلانه.",
        "ه": "این گزینه نشان دهنده نیاز به ثبات رویه بیشتر در برخورد با بدقولی و مرزبندی سالم است. پیام این گزینه می تواند این باشد که شما نیاز دارید آگاهانه تر به نحوه واکنش خود در موقعیت های مختلف توجه کنید و سعی کنید رویکرد قاطعانه تر و مسئولیت پذیرانه تری را در پیش بگیرید."
        }
    },
    {
    "text": "سوال 20:  به نظر شما، مهمترین عامل موفقیت یک رابطه بلندمدت چیست؟",
    "options": {
        "الف": "جذابیت ظاهری و جنسی\nو حفظ هیجان اولیه رابطه.",
        "ب": "ثروت و موقعیت اجتماعی\nو تامین آسایش مالی.",
        "ج": "عشق، احترام متقابل، درک، همدلی،\nارتباط موثر و تلاش مشترک برای حل مشکلات.",
        "د": "سازگاری کامل در همه زمینه ها\nو نداشتن هیچ اختلاف نظری.",
        "ه": "بسته به تعریف شخصی از موفقیت و شرایط رابطه،\nعوامل مختلفی می تواند نقش داشته باشد."
        },
    "scores": {
        "الف": 1,
        "ب": 1,
        "ج": 5,
        "د": 1,
        "ه": 4
        },
    "messages": {
        "الف": "این گزینه نشان دهنده تمرکز بر جنبه های سطحی و زودگذر رابطه و نادیده گرفتن عوامل اساسی موفقیت بلندمدت است. پیام این گزینه می تواند این باشد که شما نیاز دارید درک عمیق تری از عوامل کلیدی پایداری و موفقیت روابط بلندمدت پیدا کنید.",
        "ب": "این گزینه نشان دهنده نگاه ابزاری و مادی گرایانه به رابطه و نادیده گرفتن ابعاد عاطفی و روانی آن است. پیام این گزینه می تواند این باشد که شما نیاز دارید بپذیرید که روابط بلندمدت موفق بر پایه های عمیق تری از جمله عشق، احترام و همدلی بنا می شوند، نه صرفا مادیات.",
        "ج": "این گزینه نشان دهنده درک درست و جامع از عوامل موفقیت یک رابطه بلندمدت است. پیام این گزینه این است که شما می دانید روابط بلندمدت موفق بر پایه عشق، احترام متقابل، درک، همدلی، ارتباط موثر و تلاش مشترک برای حل مشکلات بنا می شوند. این یک دیدگاه بالغانه و مثبت برای آمادگی رابطه است.",
        "د": "این گزینه نشان دهنده انتظار غیرواقعی از رابطه و عدم درک تفاوت های فردی است. پیام این گزینه می تواند این باشد که شما نیاز دارید بپذیرید که سازگاری کامل غیرممکن است و روابط سالم بر پایه پذیرش تفاوت ها و تلاش برای حل اختلافات بنا می شوند، نه حذف آنها.",
        "ه": "این گزینه نشان دهنده درک نسبی از فردی بودن مفهوم موفقیت، اما عدم تاکید کافی بر عوامل اساسی آن است. پیام این گزینه می تواند این باشد که شما نیاز دارید در کنار توجه به تعریف شخصی از موفقیت، به عوامل اساسی و مشترک موفقیت روابط بلندمدت سالم نیز توجه کنید."
        }
    }
]

# --- توابع شروع و دریافت اطلاعات کاربر ---
async def start_relationship_test(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text("سلام! به تست آمادگی رابطه خوش آمدید.\nلطفاً نام خود را وارد کنید:")
    context.user_data.clear()
    return NAME

async def get_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["Name"] = update.message.text
    await update.message.reply_text("چند سال دارید؟")
    return AGE

async def get_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["Age"] = update.message.text
    context.user_data["current_question"] = 0
    context.user_data["total_score"] = 0
    context.user_data["responses"] = {}
    await send_question(update, context)
    return QUESTION

# --- ارسال سوال به همراه دکمه‌های تعاملی ---
async def send_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q_index = context.user_data["current_question"]
    if q_index < len(questions):
        question = questions[q_index]
        text = question["text"]
        keyboard = []
        for key, option in question["options"].items():
            keyboard.append([InlineKeyboardButton(f"{key}) {option}", callback_data=key)]) # کلید ها به صورت الف، ب، ج، د، ه نمایش داده میشوند
        reply_markup = InlineKeyboardMarkup(keyboard)
        if update.message: # برای شروع تست
            await update.message.reply_text(text, reply_markup=reply_markup)
        elif update.callback_query: # برای ادامه تست
            await update.callback_query.message.reply_text(text, reply_markup=reply_markup)
    else:
        await send_final_result(update, context)

# --- دریافت پاسخ سوال (از طریق callback query) ---
async def question_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    selected_option = query.data
    q_index = context.user_data["current_question"]
    question = questions[q_index]
    score = question["scores"].get(selected_option, 0)
    context.user_data["total_score"] += score
    context.user_data["responses"][q_index] = {
        "question": question["text"],
        "selected_option": selected_option,
        "option_text": question["options"][selected_option],
        "message": question["messages"][selected_option],
        "score": score
    }
    context.user_data["current_question"] += 1
    if context.user_data["current_question"] < len(questions):
        await send_question(update, context)
        return QUESTION
    else:
        await send_final_result(update, context)
        return ConversationHandler.END

# --- ارسال نتیجه نهایی به همراه درصد و تحلیل پاسخ‌ها ---
async def send_final_result(update: Update, context: ContextTypes.DEFAULT_TYPE):
    total_score = context.user_data["total_score"]
    max_score = len(questions) * 5  # هر سوال حداکثر 5 امتیاز دارد (بالاترین امتیاز گزینه 'ب' یا 'ج')
    percentage = (total_score / max_score) * 100

    analysis = f"نتیجه تست آمادگی رابطه:\n\n"
    analysis += f"نام: {context.user_data.get('Name', 'نامشخص')}\n"
    analysis += f"سن: {context.user_data.get('Age', 'نامشخص')}\n\n"
    analysis += f"امتیاز کل: {total_score} از {max_score}\n"
    analysis += f"درصد آمادگی رابطه: {percentage:.2f}%\n\n"
    analysis += "تحلیل پاسخ‌های شما:\n"
    for idx, resp in context.user_data["responses"].items():
        analysis += f"\nسوال {idx + 1}: {resp['question']}\n"
        analysis += f"گزینه انتخاب شده: {resp['selected_option']}) {resp['option_text']}\n"
        analysis += f"پیام: {resp['message']}\n"

    # تفسیر کلی بر اساس درصد (با توجه به سیستم ۵ گزینه‌ای)
    if percentage >= 80:
        interpretation = "شما آمادگی بسیار بالایی برای ورود به رابطه دارید. نقاط قوت زیادی در سواد رابطه و مهارت‌های ارتباطی خود نشان داده‌اید."
    elif percentage >= 60:
        interpretation = "شما آمادگی خوبی برای رابطه دارید. با کمی تمرکز بر بهبود مهارت‌ها، می‌توانید روابط موفق‌تری داشته باشید."
    elif percentage >= 40:
        interpretation = "آمادگی شما برای رابطه متوسط است. توصیه می‌شود برای بهبود کیفیت روابط خود، بیشتر بر روی سواد رابطه و مهارت‌های فردی کار کنید."
    else:
        interpretation = "به نظر می‌رسد آمادگی شما برای رابطه هنوز پایین است. پیشنهاد می‌شود قبل از ورود به رابطه، با مطالعه و مشاوره، سطح آگاهی و آمادگی خود را افزایش دهید."

    analysis += f"\n\nتفسیر نهایی: {interpretation}"

    chat_id = update.effective_chat.id  # گرفتن شناسه چت به صورت مطمئن تر

    try: # اضافه کردن try-except برای مدیریت خطا
        await context.bot.send_message(chat_id=chat_id, text=analysis, parse_mode="Markdown")
    except Exception as e:
        print(f"Error sending final result message: {e}") # چاپ خطای کامل برای بررسی بیشتر

# --- تابع لغو مکالمه ---
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text('مکالمه لغو شد.')
    return ConversationHandler.END

# --- ایجاد ConversationHandler ---
relationship_conversation_handler = ConversationHandler(
    entry_points=[CommandHandler('start_relationship_readiness', start_relationship_test)], # تغییر نام کامند
    states={
        NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_name)],
        AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_age)],
        QUESTION: [CallbackQueryHandler(question_callback)],
    },
    fallbacks=[CommandHandler('cancel', cancel)]
)

async def error_handler(update, context):
    print(f"An error occurred: {context.error}")
