import logging
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
)

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)

# تعریف مراحل مکالمه
NAME, AGE, QUESTION = range(3)

# سوالات تست اختلال دوقطبی (MDQ)
questions = [
    {
        "text": "سوال ۱. احساس می‌کنم انرژی بی‌پایانی دارم و نیاز به خوابم به شدت کاهش یافته است.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: انرژی متعادل و نیاز نرمال به خواب، نشانگر خوبی است. راهکار: به حفظ این تعادل با ریتم شبانه‌روزی منظم و مدیریت استرس ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: کاهش جزئی انرژی یا خواب گه‌گاه طبیعی است. راهکار: به کیفیت خواب و استراحت خود توجه کنید و در صورت تکرار، الگوها را بررسی کنید.",
            "3": "🟡 گاهی: پیشنهاد: نوسانات انرژی و خواب گاهی نیاز به بررسی دارد. راهکار: رویدادهای استرس‌زا را شناسایی و مدیریت کنید. تکنیک‌های تنظیم خواب را تمرین کنید.",
            "4": "🟠 اغلب: پیشنهاد: کاهش مکرر نیاز به خواب و انرژی بالا، نیازمند توجه است. راهکار: به روانپزشک مراجعه کنید. بررسی احتمال اختلالات خلقی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: در اسرع وقت با روانپزشک مشورت کنید. درمان برای تنظیم خلق و خواب ضروری است."
        }
    },
    {
        "text": "سوال ۲. دوره‌هایی دارم که خلق من بسیار بالا می‌رود و احساس می‌کنم می‌توانم هر کاری را انجام دهم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: ثبات خلقی نشانه مثبتی است. راهکار: از این ثبات لذت ببرید و مهارت‌های تاب‌آوری را تقویت کنید.",
            "2": "🔵 به ندرت: پیشنهاد: خوش‌بینی گه‌گاه طبیعی است. راهکار: حواستان به افراط در خوش‌بینی و رفتارهای تکانشی باشد.",
            "3": "🟡 گاهی: پیشنهاد: نوسانات خلقی نیاز به بررسی دارد. راهکار: موقعیت‌هایی که باعث این حالات می‌شوند را شناسایی و مدیریت کنید.",
            "4": "🟠 اغلب: پیشنهاد: خلق بسیار بالا و احساس 'توانایی مطلق'، نیازمند بررسی است. راهکار: مشاوره با روانپزشک برای ارزیابی دقیق‌تر توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای تنظیم خلق و جلوگیری از پیامدهای منفی ضروری است."
        }
    },
    {
        "text": "سوال ۳. در برخی دوره‌ها، آنقدر بی‌قرارم که نمی‌توانم یکجا بنشینم یا تمرکز کنم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: تمرکز و آرامش، وضعیت ایده‌آل است. راهکار: به حفظ این وضعیت با تمرین ذهن‌آگاهی و کاهش محرک‌های استرس‌زا ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: بی‌قراری گه‌گاه در شرایط خاص طبیعی است. راهکار: موقعیت‌های استرس‌زا را شناسایی و روش‌های مقابله سالم را تمرین کنید.",
            "3": "🟡 گاهی: پیشنهاد: بی‌قراری و مشکل تمرکز گاهی نیاز به بررسی دارد. راهکار: تکنیک‌های تمرکز (مانند مدیتیشن) و مدیریت زمان را امتحان کنید.",
            "4": "🟠 اغلب: پیشنهاد: بی‌قراری و مشکل تمرکز مکرر، نیازمند توجه است. راهکار: مشاوره با روانپزشک برای بررسی اختلالات تمرکز یا اضطراب توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای کاهش بی‌قراری و بهبود تمرکز ضروری است."
        }
    },
    {
        "text": "سوال ۴. بدون برنامه‌ریزی قبلی، تصمیمات بزرگ مالی یا شخصی می‌گیرم (مثل خریدهای غیرمنطقی یا سفر ناگهانی).",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: تصمیم‌گیری سنجیده نشانه خوبی است. راهکار: به این روند عاقلانه ادامه دهید و از تصمیمات تکانشی دوری کنید.",
            "2": "🔵 به ندرت: پیشنهاد: تصمیمات تکانشی گه‌گاه ممکن است رخ دهد. راهکار: تلاش کنید قبل از تصمیم‌گیری‌های مهم، کمی مکث و فکر کنید.",
            "3": "🟡 گاهی: پیشنهاد: تصمیمات ناگهانی گاهی نیاز به بررسی دارد. راهکار: هنگام تصمیم‌گیری، از نظر مشورت‌کنندگان مورد اعتماد کمک بگیرید.",
            "4": "🟠 اغلب: پیشنهاد: تصمیمات بزرگ بدون برنامه‌ریزی مکرر، نیازمند توجه است. راهکار: مشاوره مالی و روان‌شناختی برای بهبود کنترل تکانه‌ها توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای کنترل رفتارهای تکانشی و پیشگیری از آسیب‌های مالی/شخصی ضروری است."
        }
    },
    {
        "text": "سوال ۵. در دوره‌هایی، آنقدر سریع صحبت می‌کنم که دیگران متوجه حرف‌هایم نمی‌شوند.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: وضوح کلام و ارتباط موثر، نشانه خوبی است. راهکار: به مهارت‌های ارتباطی خود ادامه دهید و به بازخورد دیگران توجه کنید.",
            "2": "🔵 به ندرت: پیشنهاد: سریع صحبت کردن گه‌گاه در شرایط هیجانی طبیعی است. راهکار: تلاش کنید در گفتگوها، آگاهانه سرعت صحبت خود را کنترل کنید.",
            "3": "🟡 گاهی: پیشنهاد: سرعت بالای صحبت گاهی نیاز به بررسی دارد. راهکار: در موقعیت‌های اجتماعی، به بازخورد مخاطبان توجه کنید و سرعت کلام خود را تنظیم نمایید.",
            "4": "🟠 اغلب: پیشنهاد: سریع صحبت کردن مکرر و نامفهوم، نیازمند توجه است. راهکار: مشاوره گفتاردرمانی یا روان‌شناختی برای بهبود ارتباط و کنترل سرعت کلام توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای تنظیم سرعت گفتار و بهبود ارتباطات اجتماعی ضروری است."
        }
    },
    {
        "text": "سوال ۶. افکارم به شدت سریع و پشت سر هم می‌آیند، طوری که نمی‌توانم آن‌ها را کنترل کنم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: ذهن آرام و افکار قابل کنترل، وضعیت مطلوبی است. راهکار: به تمرین ذهن‌آگاهی و مدیتیشن برای حفظ این وضعیت ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: هجوم افکار گه‌گاه در شرایط خاص طبیعی است. راهکار: موقعیت‌های استرس‌زا را شناسایی و تکنیک‌های آرام‌سازی ذهن را تمرین کنید.",
            "3": "🟡 گاهی: پیشنهاد: هجوم افکار گاهی نیاز به بررسی دارد. راهکار: تمرینات منظم ذهن‌آگاهی و ثبت افکار برای مدیریت آن‌ها را امتحان کنید.",
            "4": "🟠 اغلب: پیشنهاد: هجوم افکار مکرر و غیرقابل کنترل، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای مدیریت افکار مزاحم و اضطراب توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای کنترل افکار آشفته و بهبود عملکرد ذهنی ضروری است."
        }
    },
    {
        "text": "سوال ۷. در برخی دوره‌ها، رفتارهای پرخطر (مثل مصرف مواد، رانندگی بی‌پروا) انجام می‌دهم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: اجتناب از رفتارهای پرخطر، نشانه مسئولیت‌پذیری است. راهکار: به این سبک زندگی سالم و ایمن ادامه دهید و از موقعیت‌های پرخطر دوری کنید.",
            "2": "🔵 به ندرت: پیشنهاد: رفتار پرخطر گه‌گاه ممکن است در شرایط خاص رخ دهد. راهکار: آگاهانه از رفتارهای تکانشی و پرخطر اجتناب کنید و به پیامدهای آن‌ها فکر کنید.",
            "3": "🟡 گاهی: پیشنهاد: رفتارهای پرخطر گاهی نیاز به بررسی دارد. راهکار: انگیزه‌های پشت این رفتارها را شناسایی و روش‌های جایگزین و سالم برای مقابله با آن‌ها پیدا کنید.",
            "4": "🟠 اغلب: پیشنهاد: رفتارهای پرخطر مکرر، نیازمند توجه جدی است. راهکار: مشاوره روان‌شناختی برای بررسی اعتیاد یا اختلالات کنترل تکانه توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای کنترل رفتارهای پرخطر و جلوگیری از آسیب به خود و دیگران ضروری است."
        }
    },
    {
        "text": "سوال ۸. احساس می‌کنم قدرت یا توانایی خاصی دارم که دیگران ندارند (مثل نجات جهان!).",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: دیدگاه واقع‌بینانه به توانایی‌ها، نشانه سلامت روان است. راهکار: به خودآگاهی و رشد فردی در مسیر واقع‌بینانه ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: احساس غرور گه‌گاه طبیعی است. راهکار: حواستان به خودبزرگ‌بینی و دور شدن از واقعیت باشد.",
            "3": "🟡 گاهی: پیشنهاد: احساس قدرت خاص گاهی نیاز به بررسی دارد. راهکار: انگیزه‌های این احساس را بررسی و تلاش کنید با واقعیت هماهنگ‌تر شوید.",
            "4": "🟠 اغلب: پیشنهاد: احساس قدرت خاص و غیرواقعی مکرر، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی اختلالات خودبزرگ‌بینی یا خلقی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای تعدیل خودبزرگ‌بینی و بازگشت به دیدگاه واقع‌بینانه ضروری است."
        }
    },
    {
        "text": "سوال ۹. دوره‌هایی دارم که به شدت افسرده و ناامید هستم و علاقه‌ای به زندگی ندارم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: احساس شادی و امیدواری، نشانه سلامت روان است. راهکار: به تقویت عوامل شادی‌بخش زندگی و شبکه‌های حمایتی ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: احساس ناامیدی گه‌گاه در شرایط سخت طبیعی است. راهکار: با موقعیت‌های استرس‌زا مقابله کنید و از حمایت اجتماعی بهره‌مند شوید.",
            "3": "🟡 گاهی: پیشنهاد: احساس افسردگی و ناامیدی گاهی نیاز به بررسی دارد. راهکار: فعالیت‌های لذت‌بخش را افزایش داده و با افراد مورد اعتماد صحبت کنید.",
            "4": "🟠 اغلب: پیشنهاد: احساس افسردگی و ناامیدی مکرر، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی اختلالات خلقی یا افسردگی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای رفع افسردگی و بازگشت به زندگی فعال ضروری است."
        }
    },
    {
        "text": "سوال ۱۰. تغییرات شدید وزن یا اشتها (افزایش یا کاهش چشمگیر) را تجربه می‌کنم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: وزن و اشتهای متعادل، نشانه سلامت جسم و روان است. راهکار: به تغذیه سالم و سبک زندگی فعال ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: تغییرات جزئی وزن/اشتها گه‌گاه طبیعی است. راهکار: الگوهای غذایی خود را بررسی کنید و در صورت تکرار، با پزشک مشورت نمایید.",
            "3": "🟡 گاهی: پیشنهاد: تغییرات وزن/اشتها گاهی نیاز به بررسی دارد. راهکار: به عوامل استرس‌زا و عادات غذایی خود توجه کنید.",
            "4": "🟠 اغلب: پیشنهاد: تغییرات شدید وزن/اشتها مکرر، نیازمند توجه است. راهکار: مشاوره پزشکی و روان‌شناختی برای بررسی اختلالات خوردن یا خلقی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به پزشک مراجعه کنید. ارزیابی پزشکی و احتمالا روانپزشکی برای تشخیص علت تغییرات وزن/اشتها ضروری است."
        }
    },
    {
        "text": "سوال ۱۱. در دوره‌های افسردگی، احساس می‌کنم ارزش زندگی کردن ندارم یا به مرگ فکر می‌کنم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: ارزشمندی زندگی و عدم تمایل به مرگ، نشانه سلامت روان است. راهکار: به تقویت عوامل محافظت‌کننده سلامت روان ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: فکر به مرگ گه‌گاه در شرایط سخت ممکن است رخ دهد. راهکار: در صورت تکرار این افکار، از حمایت اجتماعی و حرفه‌ای کمک بگیرید.",
            "3": "🟡 گاهی: پیشنهاد: فکر به بی‌ارزشی زندگی گاهی نیاز به بررسی دارد. راهکار: با یک متخصص روان‌شناس یا مشاور صحبت کنید.",
            "4": "🟠 اغلب: پیشنهاد: احساس بی‌ارزشی و فکر به مرگ مکرر، نیازمند توجه جدی است. راهکار: مشاوره روانپزشکی فوری برای ارزیابی خطر خودکشی و درمان ضروری است.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت اورژانسی است و نیازمند اقدام فوری است. راهکار: فوراً با اورژانس اجتماعی (123) یا مراکز روانپزشکی تماس بگیرید. درمان فوری برای جلوگیری از خودکشی ضروری است."
        }
    },
    {
        "text": "سوال ۱۲. خلق من به سرعت از شیدایی به افسردگی یا برعکس تغییر می‌کند.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: ثبات خلقی، نشانه خوبی است. راهکار: به حفظ ثبات و مدیریت هیجانات با روش‌های سالم ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: تغییرات خلقی گه‌گاه در پاسخ به رویدادها طبیعی است. راهکار: به عوامل محیطی و رویدادهای زندگی که باعث نوسانات خلقی می‌شوند توجه کنید.",
            "3": "🟡 گاهی: پیشنهاد: نوسانات خلقی گاهی نیاز به بررسی دارد. راهکار: ثبت روزانه خلق و بررسی الگوهای نوسانات می‌تواند مفید باشد.",
            "4": "🟠 اغلب: پیشنهاد: تغییرات خلقی سریع و مکرر، نیازمند توجه است. راهکار: مشاوره روانپزشکی برای بررسی اختلالات خلقی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای تنظیم نوسانات خلقی و بهبود عملکرد روزمره ضروری است."
        }
    },
    {
        "text": "سوال ۱۳. در دوره‌های شیدایی، تحریک‌پذیر هستم و به راحتی عصبانی می‌شوم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: کنترل خشم و آرامش، نشانه خوبی است. راهکار: به تمرین روش‌های مدیریت خشم و حفظ آرامش ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: تحریک‌پذیری گه‌گاه در شرایط استرس‌زا طبیعی است. راهکار: تکنیک‌های مدیریت خشم را تمرین کنید و موقعیت‌های تنش‌زا را کاهش دهید.",
            "3": "🟡 گاهی: پیشنهاد: تحریک‌پذیری و عصبانیت گاهی نیاز به بررسی دارد. راهکار: موقعیت‌ها و عوامل تحریک‌کننده را شناسایی کنید و راهبردهای مقابله سالم را بیاموزید.",
            "4": "🟠 اغلب: پیشنهاد: تحریک‌پذیری و عصبانیت مکرر در حالت شیدایی، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای مدیریت خشم و بررسی اختلالات خلقی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای کنترل خشم و جلوگیری از رفتارهای پرخاشگرانه ضروری است."
        }
    },
    {
        "text": "سوال ۱۴. در برخی دوره‌ها، میل جنسی‌ام به شکل غیرعادی افزایش می‌یابد.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: میل جنسی متعادل، نشانه سلامت جنسی است. راهکار: به حفظ این تعادل و رابطه سالم با جنبه جنسی زندگی ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: نوسانات میل جنسی گه‌گاه طبیعی است. راهکار: به عوامل هورمونی، استرس و سلامت جسمی خود توجه کنید.",
            "3": "🟡 گاهی: پیشنهاد: افزایش غیرعادی میل جنسی گاهی نیاز به بررسی دارد. راهکار: الگوهای میل جنسی خود را بررسی و در صورت نگرانی، با متخصص مشورت کنید.",
            "4": "🟠 اغلب: پیشنهاد: افزایش غیرعادی میل جنسی مکرر، نیازمند توجه است. راهکار: مشاوره روانپزشکی برای بررسی اختلالات خلقی یا رفتارهای تکانشی جنسی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای تنظیم میل جنسی غیرعادی و جلوگیری از رفتارهای پرخطر احتمالی ضروری است."
        }
    },
    {
        "text": "سوال ۱۵. در دوره‌های افسردگی، حتی کارهای ساده (مثل دوش گرفتن) برایم غیرممکن است.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: توانایی انجام کارهای روزمره، نشانه عملکرد خوب است. راهکار: به حفظ روال منظم زندگی و فعالیت روزانه ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: مشکل در انجام کارهای ساده گه‌گاه در شرایط خستگی طبیعی است. راهکار: به استراحت کافی و تجدید قوا توجه کنید.",
            "3": "🟡 گاهی: پیشنهاد: مشکل در انجام کارهای ساده گاهی نیاز به بررسی دارد. راهکار: میزان خستگی، استرس و انگیزه خود را بررسی کنید.",
            "4": "🟠 اغلب: پیشنهاد: مشکل مکرر در انجام کارهای ساده، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی افسردگی و کمک به بازیابی عملکرد توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای رفع ناتوانی در انجام کارهای روزمره و بهبود کیفیت زندگی ضروری است."
        }
    },
    {
        "text": "سوال ۱۶. دوستان یا خانواده به من گفته‌اند که در برخی دوره‌ها رفتارم غیرعادی است.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: رفتار متعادل و مورد قبول اجتماع، نشانه خوبی است. راهکار: به روابط سالم و تعاملات اجتماعی مثبت ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: بازخورد گه‌گاه در مورد رفتار، طبیعی است. راهکار: به بازخورد دیگران توجه کنید و در رفتارهای خود بازنگری نمایید.",
            "3": "🟡 گاهی: پیشنهاد: بازخورد در مورد رفتارهای غیرعادی گاهی نیاز به بررسی دارد. راهکار: از دوستان و خانواده در مورد رفتارهای خود بیشتر سوال کنید و به نظرات آن‌ها توجه نمایید.",
            "4": "🟠 اغلب: پیشنهاد: بازخورد مکرر در مورد رفتارهای غیرعادی، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی رفتارهای اجتماعی و تاثیر آن‌ها بر روابط توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. ارزیابی رفتاری و درمان برای بهبود تعاملات اجتماعی و کاهش رفتارهای مشکل‌ساز ضروری است."
        }
    },
    {
        "text": "سوال ۱۷. در دوره‌های شیدایی، پروژه‌های زیادی شروع می‌کنم اما هیچ‌کدام را تمام نمی‌کنم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: تکمیل پروژه‌ها و پیگیری اهداف، نشانه خوبی است. راهکار: به مهارت‌های برنامه‌ریزی و پیگیری اهداف خود ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: نیمه‌کاره رها کردن پروژه گه‌گاه ممکن است رخ دهد. راهکار: مهارت‌های مدیریت زمان و اولویت‌بندی کارها را تقویت کنید.",
            "3": "🟡 گاهی: پیشنهاد: شروع پروژه‌های ناتمام گاهی نیاز به بررسی دارد. راهکار: انگیزه و تمرکز خود را بررسی کنید و اهداف واقع‌بینانه‌تر تعیین نمایید.",
            "4": "🟠 اغلب: پیشنهاد: شروع پروژه‌های ناتمام مکرر، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی اختلالات خلقی یا کمبود توجه توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای بهبود تمرکز، پیگیری اهداف و افزایش بهره‌وری ضروری است."
        }
    },
    {
        "text": "سوال ۱۸. در دوره‌های افسردگی، احساس گناه یا بی‌ارزشی شدید می‌کنم.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: احساس ارزشمندی و عدم احساس گناه بی‌دلیل، نشانه سلامت روان است. راهکار: به تقویت اعتماد به نفس و دیدگاه مثبت به خود ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: احساس گناه گه‌گاه در شرایط اشتباه طبیعی است. راهکار: با خود مهربان باشید و اشتباهات را به عنوان فرصتی برای یادگیری بپذیرید.",
            "3": "🟡 گاهی: پیشنهاد: احساس گناه یا بی‌ارزشی گاهی نیاز به بررسی دارد. راهکار: با خودتان مهربان‌تر باشید و به نقاط قوت خود توجه کنید.",
            "4": "🟠 اغلب: پیشنهاد: احساس گناه یا بی‌ارزشی مکرر، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی افسردگی و بهبود عزت نفس توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای رفع احساس گناه و بی‌ارزشی و بازگرداندن حس ارزشمندی ضروری است."
        }
    },
    {
        "text": "سوال ۱۹. نیاز دارم دیگران مدام مرا تحسین کنند یا توجه شدیدی به من داشته باشند.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: خودکفایی و اعتماد به نفس درونی، نشانه خوبی است. راهکار: به استقلال و اتکا به خود ادامه دهید و ارزش خود را در درون بیابید.",
            "2": "🔵 به ندرت: پیشنهاد: نیاز به تایید گه‌گاه طبیعی است. راهکار: تلاش کنید بیشتر به تایید و رضایت درونی خود تکیه کنید.",
            "3": "🟡 گاهی: پیشنهاد: نیاز به تحسین گاهی نیاز به بررسی دارد. راهکار: ریشه این نیاز را بررسی و تلاش کنید اعتماد به نفس خود را تقویت کنید.",
            "4": "🟠 اغلب: پیشنهاد: نیاز مکرر به تحسین و توجه، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی اختلالات شخصیت یا نیازهای عاطفی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای تعدیل نیاز به تایید بیرونی و تقویت حس ارزشمندی درونی ضروری است."
        }
    },
    {
        "text": "سوال ۲۰. این نوسانات خلقی روی کار، تحصیل یا روابطم تأثیر منفی گذاشته است.",
        "options": {
            "1": "🟢 هرگز",
            "2": "🔵 به ندرت",
            "3": "🟡 گاهی",
            "4": "🟠 اغلب",
            "5": "🔴 همیشه"
        },
        "scores": {
            "1": 0,
            "2": 1,
            "3": 2,
            "4": 3,
            "5": 4
        },
        "messages": {
            "1": "🟢 هرگز: پیشنهاد: عدم تاثیر منفی نوسانات خلقی بر زندگی، نشانه عملکرد خوب است. راهکار: به حفظ تعادل و مدیریت هیجانات به منظور حفظ عملکرد مطلوب ادامه دهید.",
            "2": "🔵 به ندرت: پیشنهاد: تاثیر منفی گه‌گاه بر زندگی ممکن است رخ دهد. راهکار: مهارت‌های حل مسئله و مدیریت تعارض را تقویت کنید.",
            "3": "🟡 گاهی: پیشنهاد: تاثیر منفی گاهی نوسانات خلقی نیاز به بررسی دارد. راهکار: تاثیر این نوسانات را بر جنبه‌های مختلف زندگی خود بررسی و تلاش کنید راهکارهای کاهش تاثیرات منفی را بیابید.",
            "4": "🟠 اغلب: پیشنهاد: تاثیر منفی مکرر نوسانات خلقی، نیازمند توجه است. راهکار: مشاوره روان‌شناختی برای بررسی و درمان اختلالات خلقی و بهبود عملکرد در زندگی توصیه می‌شود.",
            "5": "🔴 همیشه: پیشنهاد: این وضعیت نیازمند بررسی فوری است. راهکار: به روانپزشک مراجعه کنید. درمان برای کاهش تاثیر منفی نوسانات خلقی و بهبود عملکرد کلی زندگی ضروری است."
        }
    }
]

# --- توابع شروع و دریافت اطلاعات کاربر ---
async def start_mdq_test(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text("سلام! به تست اختلال دوقطبی (MDQ) خوش آمدید.\nلطفاً نام خود را وارد کنید:")
    context.user_data.clear()
    return NAME

async def get_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["Name"] = update.message.text
    await update.message.reply_text("چند سال دارید؟")
    return AGE

async def get_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["Age"] = update.message.text
    context.user_data["current_question"] = 0
    context.user_data["total_score"] = 0
    context.user_data["responses"] = {}
    await send_question(update, context)
    return QUESTION

# --- ارسال سوال به همراه دکمه‌های تعاملی ---
async def send_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q_index = context.user_data["current_question"]
    if q_index < len(questions):
        question = questions[q_index]
        text = question["text"]
        keyboard = []
        for key, option in question["options"].items():
            keyboard.append([InlineKeyboardButton(f"{key}) {option}", callback_data=key)])
        reply_markup = InlineKeyboardMarkup(keyboard)
        if update.message:  # برای شروع تست
            await update.message.reply_text(text, reply_markup=reply_markup)
        elif update.callback_query:  # برای ادامه تست
            await update.callback_query.message.reply_text(text, reply_markup=reply_markup)
    else:
        await send_final_result(update, context)

# --- دریافت پاسخ سوال (از طریق CallbackQuery) ---
async def question_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    selected_option = query.data
    q_index = context.user_data["current_question"]
    question = questions[q_index]
    score = question["scores"].get(selected_option, 0)
    context.user_data["total_score"] += score
    context.user_data["responses"][q_index] = {
        "question": question["text"],
        "selected_option": selected_option,
        "option_text": question["options"][selected_option],
        "message": question["messages"][selected_option],
        "score": score
    }
    context.user_data["current_question"] += 1
    if context.user_data["current_question"] < len(questions):
        await send_question(update, context)
        return QUESTION
    else:
        await send_final_result(update, context)
        return ConversationHandler.END

# --- ارسال نتیجه نهایی به همراه تحلیل پاسخ‌ها ---
async def send_final_result(update: Update, context: ContextTypes.DEFAULT_TYPE):
    total_score = context.user_data["total_score"]
    max_score = len(questions) * 4  # هر سوال حداکثر 4 امتیاز دارد (20 * 4 = 80)
    percentage = (total_score / max_score) * 100

    analysis = f"نتیجه تست اختلال دوقطبی (MDQ):\n\n"
    analysis += f"نام: {context.user_data.get('Name', 'نامشخص')}\n"
    analysis += f"سن: {context.user_data.get('Age', 'نامشخص')}\n\n"
    analysis += f"امتیاز کل: {total_score} از {max_score}\n"
    analysis += f"درصد MDQ: {percentage:.2f}%\n\n"
    analysis += "تحلیل پاسخ‌های شما:\n"
    for idx, resp in context.user_data["responses"].items():
        analysis += f"\nسوال {idx + 1}: {resp['question']}\n"
        analysis += f"گزینه انتخاب شده: {resp['selected_option']}) {resp['option_text']}\n"
        analysis += f"{resp['message']}\n"

    # تفسیر کلی (این تفسیر می‌تواند بر اساس سیاست‌های مختلف تنظیم شود)
    if total_score < 25:
        interpretation = "شما نشانه‌های کمی از اختلال دوقطبی دارید."
    elif total_score < 50:
        interpretation = "ممکن است دارای اختلال دوقطبی با شدت خفیف تا متوسط باشید. مشاوره با متخصص توصیه می‌شود."
    elif total_score < 75:
        interpretation = "نشانه‌های قابل توجه اختلال دوقطبی وجود دارد. توصیه می‌شود با یک روانپزشک مشورت کنید."
    else:
        interpretation = "علائم شدید اختلال دوقطبی وجود دارد؛ نیاز به ارزیابی و درمان تخصصی فوری است."

    analysis += f"\n\nتفسیر نهایی: {interpretation}\n\n"
    analysis += "توصیه کلی:\n"
    analysis += "1. توجه به الگوهای خلقی و مدیریت استرس و هیجانات.\n"
    analysis += "2. استفاده از تکنیک‌های شناختی-رفتاری (CBT) و مدیریت هیجانات.\n"
    analysis += "3. در صورت بروز نوسانات شدید یا اختلال در عملکرد روزانه، مشاوره تخصصی ضروری است."

    if update.callback_query:
        await update.callback_query.message.reply_text(analysis, parse_mode="Markdown")
    else:
        await update.message.reply_text(analysis, parse_mode="Markdown")

# --- تابع لغو مکالمه ---
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text('مکالمه لغو شد.')
    return ConversationHandler.END

# --- ایجاد ConversationHandler برای تست MDQ ---
mdq_conversation_handler = ConversationHandler(
    entry_points=[CommandHandler('start_mdq', start_mdq_test)],
    states={
        NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_name)],
        AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_age)],
        QUESTION: [CallbackQueryHandler(question_callback)],
    },
    fallbacks=[CommandHandler('cancel', cancel)]
)

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(msg="Exception while handling an update:", exc_info=context.error)
